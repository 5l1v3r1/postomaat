Configuration
=============

Contents:

.. toctree::
   :maxdepth: 2


-------------------
Basic Configuration
-------------------

Postomaat
.........

First of all, rename remove the .dist ending from all files in ``/etc/postomaat``, so you have a basic default configuration.

edit ``/etc/postomaat/postomaat.conf`` and change parameters if you like


Then check if postomaat is happy with your configuration:


::

	postomaat --lint




Postfix
.......

Once postomaat is up and running, we need to tell Postfix to use it as an policy access daemon

Detailed documentation is available on the `postfix <http://www.postfix.org/SMTPD_POLICY_README.html>`_ website.

here is a quick example.


in ``main.cf`` add


::

	smtpd_recipient_restrictions = permit_mynetworks,
                               reject_unauth_pipelining,
                               reject_unauth_destination,
                               check_policy_service inet:127.0.0.1:9998



run ``postfix reload`` and check your maillog for errors. from now on, messages should be filtered by postomaat!


----------------------
Advanced Configuration
----------------------

Running different configurations on different Ports
...................................................

Running multiple configurations can be handy if you want to make different decisions in other postfix connection stages, for example
smtpd_client_restrictions and smtpd_recipient_restrictions.

to run different plugins on different ports, use the "incomingport" option in postomaat.configuration. make sure all plugins are being loaded in "plugins=".

example:

::

  incomingport=9998:plugin1,plugin2,plugin3 9997:plugin2,plugin3(someotherconfigsection)
  
This would run plugin1 and plugin2 with their main configuration section on port 9998, but only plugin2 and plugin3 with "[someotherconfigsection]" on port 9997.


--------------------------------------
Testing your configuration & Debugging
--------------------------------------

Dry-run without actual mail
...........................

to test your current postomaat plugins you can run `postomaat --test`  and add any parameters as defined in http://www.postfix.org/SMTPD_POLICY_README.html#protocol

for example, to simulate a message from foo@bar.com to bar@foo.com coming from IP 1.3.3.7 you would run:

::

  postomaat --test sender=foo@bar.com recipient=bar@foo.com client_address=1.3.3.7
  
Postomaat will automatically add default values for all other fields and display the result.

Additionally, you can pass the `--debug` argument to print out all debug messages.


Postomaat doesn't even start
............................

 * run ``postomaat --lint`` as root. are there any errors?
 * did you create /etc/postomaat/logging.conf (by renaming the logging.conf.dist file) ?
 * check for errors in yourmaillog
 * run postomaat in foreground by setting ``daemonize=0`` in postomaat.conf



